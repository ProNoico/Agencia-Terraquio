<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservas - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .modal-backdrop { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="h-full">
    <div class="min-h-full">
        <header class="bg-white shadow-sm">
             <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-gray-900 py-6">Gestión de Reservas</h1>
                    <a href="dashboard.html" class="text-sm text-indigo-600 hover:text-indigo-900">&larr; Volver al panel principal</a>
                </div>
                <button id="logout-button" class="rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500">Cerrar Sesión</button>
            </div>
        </header>

        <main class="py-10">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 space-y-12">
                <div>
                    <div class="sm:flex sm:items-center">
                        <div class="sm:flex-auto">
                            <h2 class="text-base font-semibold leading-6 text-gray-900">Gestión de Reservas</h2>
                            <p class="mt-2 text-sm text-gray-700">Crea, modifica y elimina las reservas de los clientes.</p>
                        </div>
                        <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
                            <button type="button" id="add-reserva-button" class="block rounded-md bg-[#033E4C] px-3 py-2 text-center text-sm font-semibold text-white shadow-sm hover:bg-opacity-90">Crear Reserva</button>
                        </div>
                    </div>
                    <div class="mt-8 flow-root">
                        <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                            <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                                <table class="min-w-full divide-y divide-gray-300">
                                    <thead>
                                        <tr>
                                            <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">Cliente</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Teléfono</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Paquete</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Fecha</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Estado</th>
                                            <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-0"><span class="sr-only">Acciones</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="reservas-table-body" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="reserva-modal" class="relative z-10 hidden" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 modal-backdrop"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <form id="reserva-form">
                        <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                            <h3 class="text-lg font-semibold leading-6 text-gray-900" id="reserva-modal-title">Crear Reserva</h3>
                            <div class="mt-4 grid grid-cols-1 gap-y-4">
                                <input type="hidden" id="reserva-id" name="id">
                                <div>
                                    <label for="user_id" class="block text-sm font-medium text-gray-700">Cliente</label>
                                    <select id="user_id" name="user_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border"></select>
                                </div>
                                
                                <div>
                                    <label for="seccion_paquete" class="block text-sm font-medium text-gray-700">Sección del Paquete</label>
                                    <select id="seccion_paquete" name="seccion_paquete" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border">
                                        <option value="">Seleccionar sección...</option>
                                        <option value="destacados">Destacados</option>
                                        <option value="grupales_paquetes">Salidas Grupales</option>
                                        <option value="eventos_paquetes">Eventos Imperdibles</option>
                                        <option value="regiones_paquetes">Regiones y Destinos</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="paquete_nombre" class="block text-sm font-medium text-gray-700">Nombre del Paquete</label>
                                    <select id="paquete_nombre" name="paquete_nombre" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border bg-gray-100" disabled>
                                        <option value="">Seleccione una sección primero</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="fecha_reserva" class="block text-sm font-medium text-gray-700">Fecha de Reserva</label>
                                    <input type="date" name="fecha_reserva" id="fecha_reserva" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border">
                                </div>
                                <div>
                                    <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                                    <select id="estado" name="estado" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border">
                                        <option>Pendiente</option>
                                        <option>Confirmada</option>
                                        <option>Pagada</option>
                                        <option>Cancelada</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="notas" class="block text-sm font-medium text-gray-700">Notas</label>
                                    <textarea name="notas" id="notas" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                            <button type="submit" class="inline-flex w-full justify-center rounded-md bg-[#033E4C] px-3 py-2 text-sm font-semibold text-white sm:ml-3 sm:w-auto">Guardar Reserva</button>
                            <button type="button" id="cancel-reserva-button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm sm:mt-0 sm:w-auto ring-1 ring-inset ring-gray-300">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & DOM ELEMENTS ---
        const SUPABASE_URL = 'https://rwndahfhxxasuwycfjug.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bmRhaGZoeHhhc3V3eWNmanVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMzA3MjUsImV4cCI6MjA2ODYwNjcyNX0.gZCP_LDl_WDqnhIIDHdqa-kWsDkYpxJ6RQxZcPtC0ZQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const logoutButton = document.getElementById('logout-button');
        const reservasTableBody = document.getElementById('reservas-table-body');
        const addReservaButton = document.getElementById('add-reserva-button');
        const reservaModal = document.getElementById('reserva-modal');
        const reservaForm = document.getElementById('reserva-form');
        const cancelReservaButton = document.getElementById('cancel-reserva-button');
        const userSelectDropdown = document.getElementById('user_id');
        const seccionSelectDropdown = document.getElementById('seccion_paquete');
        const paqueteSelectDropdown = document.getElementById('paquete_nombre');

        let reservasData = [];
        let usersData = [];
        let allPackagesByCategory = {
            destacados: [],
            grupales_paquetes: [],
            eventos_paquetes: [],
            regiones_paquetes: []
        };

        // --- 2. AUTH & SHARED FUNCTIONS ---
        const checkAdmin = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = './index.html'; return false; }
            const { data: profile, error } = await supabase.from('profiles').select('role').eq('id', session.user.id).single();
            if (error || profile?.role !== 'admin') {
                alert("Acceso denegado."); await supabase.auth.signOut(); window.location.href = './index.html'; return false;
            }
            return true;
        };

        const toggleReservaModal = () => reservaModal.classList.toggle('hidden');

        // --- 3. CRUD LOGIC & DATA FETCHING ---

        const fetchAllPackages = async () => {
            const tableNames = ['destacados', 'grupales_paquetes', 'eventos_paquetes', 'regiones_paquetes'];
            for (const table of tableNames) {
                const { data, error } = await supabase.from(table).select('nombre');
                if (data) {
                    allPackagesByCategory[table] = data.sort((a, b) => a.nombre.localeCompare(b.nombre));
                }
            }
        };

        const fetchUsers = async () => {
            const { data, error } = await supabase.rpc('get_all_users');
            if (error) { console.error('Error cargando usuarios:', error); return; }
            usersData = data;
            userSelectDropdown.innerHTML = `<option value="">Seleccionar cliente...</option>` + usersData.map(user => `<option value="${user.user_id}">${user.user_email} (${user.user_nombre || ''} ${user.user_apellido || ''})</option>`).join('');
        };

        const fetchReservas = async () => {
            const { data, error } = await supabase.rpc('get_all_reservas_with_emails');
            if (error) { 
                console.error("Error al cargar reservas:", error); 
                reservasTableBody.innerHTML = `<tr><td colspan="6" class="text-red-500 text-center py-4">Error al cargar reservas.</td></tr>`;
                return; 
            }
            reservasData = data;
            renderReservasTable();
        };

        const renderReservasTable = () => {
            if (!reservasData || reservasData.length === 0) {
                reservasTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-4">No hay reservas creadas.</td></tr>`;
                return;
            }
            reservasTableBody.innerHTML = reservasData.map(reserva => {
                const nombreCompleto = (reserva.user_nombre || reserva.user_apellido) ? `${reserva.user_nombre || ''} ${reserva.user_apellido || ''}`.trim() : reserva.user_email;
                const fecha = reserva.fecha_reserva ? new Date(reserva.fecha_reserva + 'T00:00:00').toLocaleDateString('es-AR') : 'N/A';
                
                return `
                    <tr>
                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-0">
                            <div>${nombreCompleto}</div>
                            <div class="text-xs text-gray-500">${reserva.user_email || 'Email no disponible'}</div>
                        </td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${reserva.user_telefono || 'N/A'}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${reserva.paquete_nombre}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${fecha}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${reserva.estado}</td>
                        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                            <button data-id="${reserva.id}" class="text-indigo-600 hover:text-indigo-900 edit-reserva-btn">Editar</button>
                            <button data-id="${reserva.id}" class="text-red-600 hover:text-red-900 ml-4 delete-reserva-btn">Eliminar</button>
                        </td>
                    </tr>`;
            }).join('');
        };

        const editReserva = (id) => {
            const reserva = reservasData.find(r => r.id == id);
            if (!reserva) return;
            
            reservaForm.reset();
            document.getElementById('reserva-modal-title').textContent = 'Editar Reserva';
            
            reservaForm.elements.id.value = reserva.id;
            reservaForm.elements.user_id.value = reserva.user_id;
            reservaForm.elements.fecha_reserva.value = reserva.fecha_reserva;
            reservaForm.elements.estado.value = reserva.estado;
            reservaForm.elements.notas.value = reserva.notas || '';

            let seccionEncontrada = '';
            for (const seccion in allPackagesByCategory) {
                if (allPackagesByCategory[seccion].some(pkg => pkg.nombre === reserva.paquete_nombre)) {
                    seccionEncontrada = seccion;
                    break;
                }
            }

            if (seccionEncontrada) {
                seccionSelectDropdown.value = seccionEncontrada;
                seccionSelectDropdown.dispatchEvent(new Event('change'));
                paqueteSelectDropdown.value = reserva.paquete_nombre;
            } else {
                paqueteSelectDropdown.disabled = true;
                paqueteSelectDropdown.innerHTML = '<option value="">Paquete no encontrado</option>';
            }
            
            toggleReservaModal();
        };
        
        const deleteReserva = async (id) => {
            if (confirm('¿Estás seguro de que quieres eliminar esta reserva?')) {
                const { error } = await supabase.from('reservas').delete().eq('id', id);
                if (error) { 
                    alert('Error al eliminar la reserva: ' + error.message); 
                } else { 
                    fetchReservas(); 
                }
            }
        };

        // --- 4. EVENT LISTENERS ---
        logoutButton.addEventListener('click', async () => { await supabase.auth.signOut(); window.location.href = './index.html'; });

        addReservaButton.addEventListener('click', () => {
            reservaForm.reset();
            seccionSelectDropdown.value = '';
            paqueteSelectDropdown.innerHTML = '<option value="">Seleccione una sección primero</option>';
            paqueteSelectDropdown.disabled = true;
            paqueteSelectDropdown.classList.add('bg-gray-100');
            reservaForm.elements.id.value = '';
            document.getElementById('reserva-modal-title').textContent = 'Crear Reserva';
            toggleReservaModal();
        });
        
        cancelReservaButton.addEventListener('click', toggleReservaModal);

        reservasTableBody.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            if (!id) return;
            if (e.target.classList.contains('edit-reserva-btn')) editReserva(id);
            if (e.target.classList.contains('delete-reserva-btn')) deleteReserva(id);
        });

        seccionSelectDropdown.addEventListener('change', () => {
            const selectedSection = seccionSelectDropdown.value;
            paqueteSelectDropdown.innerHTML = ''; 

            if (selectedSection && allPackagesByCategory[selectedSection]) {
                paqueteSelectDropdown.disabled = false;
                paqueteSelectDropdown.classList.remove('bg-gray-100');
                paqueteSelectDropdown.innerHTML = '<option value="">Seleccionar un paquete...</option>';
                allPackagesByCategory[selectedSection].forEach(pkg => {
                    const option = document.createElement('option');
                    option.value = pkg.nombre;
                    option.textContent = pkg.nombre;
                    paqueteSelectDropdown.appendChild(option);
                });
            } else {
                paqueteSelectDropdown.disabled = true;
                paqueteSelectDropdown.classList.add('bg-gray-100');
                paqueteSelectDropdown.innerHTML = '<option value="">Seleccione una sección primero</option>';
            }
        });

        reservaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(reservaForm);
            const reservaData = {
                user_id: formData.get('user_id'),
                paquete_nombre: formData.get('paquete_nombre'),
                fecha_reserva: formData.get('fecha_reserva'),
                estado: formData.get('estado'),
                notas: formData.get('notas'),
            };
            const reservaId = formData.get('id');
            
            let error;
            if (reservaId) { 
                const { error: updateError } = await supabase.from('reservas').update(reservaData).eq('id', reservaId); 
                error = updateError;
            } else { 
                const { error: insertError } = await supabase.from('reservas').insert([reservaData]); 
                error = insertError;
            }
            
            if (error) { 
                alert('Error al guardar la reserva: ' + error.message); 
            } else { 
                toggleReservaModal(); 
                fetchReservas(); 
            }
        });

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (!await checkAdmin()) return;
            await fetchAllPackages();
            await fetchUsers();
            await fetchReservas();
        });
    </script>
</body>
</html>