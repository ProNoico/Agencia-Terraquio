<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Terraquio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .modal-backdrop { transition: opacity 0.3s ease; }
        #drop-zone.drag-over, #banner-drop-zone.drag-over { border-color: #3b82f6; background-color: #eff6ff; }
        .tariff-item {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Adjusted for more columns */
            gap: 1rem;
            align-items: end;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
            background-color: #f8fafc;
        }
        .tariff-item .delete-tariff-btn {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
        }
        .tariff-item .delete-tariff-btn:hover {
            background-color: #dc2626;
        }
        /* Estilos para la galería */
        .gallery-image-item {
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s ease;
        }
        .gallery-image-item:hover {
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="h-full">
    <div class="min-h-full">
        <header class="bg-white shadow-sm">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 d-flex justify-between flex items-center">
                <h1 class="text-xl font-bold tracking-tight text-gray-900 py-6">Panel de Administración</h1>
                <button id="logout-button" class="rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500">Cerrar Sesión</button>
            </div>
        </header>

        <main class="py-10">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 space-y-12">
                <!-- Sección Paquetes Destacados -->
                <div>
                    <div class="sm:flex sm:items-center">
                        <div class="sm:flex-auto">
                            <h2 class="text-base font-semibold leading-6 text-gray-900">Paquetes Destacados</h2>
                            <p class="mt-2 text-sm text-gray-700">Gestiona los paquetes que aparecen en la sección "Destacados".</p>
                        </div>
                        <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
                            <button type="button" id="add-package-button" class="block rounded-md bg-[#033E4C] px-3 py-2 text-center text-sm font-semibold text-white shadow-sm hover:bg-opacity-90">Crear Paquete</button>
                        </div>
                    </div>
                    <div class="mt-8 flow-root">
                        <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                            <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                                <table class="min-w-full divide-y divide-gray-300">
                                    <thead>
                                        <tr>
                                            <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">Orden</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Nombre</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Precio</th>
                                            <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-0"><span class="sr-only">Acciones</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="packages-table-body" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección Banners de Salidas Grupales -->
                <div>
                    <div class="sm:flex sm:items-center">
                        <div class="sm:flex-auto">
                            <h2 class="text-base font-semibold leading-6 text-gray-900">Banners de Salidas Grupales</h2>
                            <p class="mt-2 text-sm text-gray-700">Gestiona los banners que rotan en la sección de Salidas Grupales.</p>
                        </div>
                        <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
                            <button type="button" id="add-banner-button" class="block rounded-md bg-[#033E4C] px-3 py-2 text-center text-sm font-semibold text-white shadow-sm hover:bg-opacity-90">Crear Banner</button>
                        </div>
                    </div>
                    <div class="mt-8 flow-root">
                        <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                            <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                                <table class="min-w-full divide-y divide-gray-300">
                                    <thead>
                                        <tr>
                                            <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">Imagen</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Texto Overlay</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Orden</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Activo</th>
                                            <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-0"><span class="sr-only">Acciones</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="banners-table-body" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección Gestión de Reservas -->
                <div>
                    <div class="sm:flex sm:items-center">
                        <div class="sm:flex-auto">
                            <h2 class="text-base font-semibold leading-6 text-gray-900">Gestión de Reservas</h2>
                            <p class="mt-2 text-sm text-gray-700">Crea, modifica y elimina las reservas de los clientes.</p>
                        </div>
                        <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
                            <button type="button" id="add-reserva-button" class="block rounded-md bg-[#033E4C] px-3 py-2 text-center text-sm font-semibold text-white shadow-sm hover:bg-opacity-90">Crear Reserva</button>
                        </div>
                    </div>
                    <div class="mt-8 flow-root">
                        <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                            <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                                <table class="min-w-full divide-y divide-gray-300">
                                    <thead>
                                        <tr>
                                            <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">Cliente</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Teléfono</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Paquete</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Fecha</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Estado</th>
                                            <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-0"><span class="sr-only">Acciones</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="reservas-table-body" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Paquetes -->
    <div id="package-modal" class="relative z-10 hidden" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 modal-backdrop"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-xl">
                    <form id="package-form">
                        <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                            <h3 class="text-lg font-semibold leading-6 text-gray-900" id="package-modal-title">Crear Paquete</h3>
                            <div class="mt-4 grid grid-cols-1 gap-y-6">
                                <input type="hidden" id="package-id" name="id">
                                <div>
                                    <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                                    <input type="text" name="nombre" id="nombre" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Imagen</label>
                                    <div id="drop-zone" class="mt-1 flex justify-center rounded-lg border-2 border-dashed border-gray-300 px-6 py-10 cursor-pointer hover:border-indigo-500">
                                        <div class="text-center">
                                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                            <p class="mt-1 text-sm text-gray-600">Arrastra y suelta o <span class="font-semibold text-indigo-600">haz clic</span></p>
                                            <input id="file-input" type="file" class="sr-only" accept="image/*">
                                        </div>
                                    </div>
                                    <p id="upload-status" class="mt-2 text-sm text-gray-500"></p>
                                    <img id="image-preview" src="" class="mt-4 rounded-lg max-h-40 hidden">
                                    <button type="button" id="select-from-gallery-btn" class="mt-2 block w-full rounded-md bg-gray-200 px-3 py-2 text-center text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-300">
                                        Seleccionar de la galería
                                    </button>
                                </div>
                                <div>
                                    <label for="imagen_url" class="block text-sm font-medium text-gray-700">URL de la Imagen</label>
                                    <input type="url" name="imagen_url" id="imagen_url" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border">
                                </div>
                                <div>
                                    <label for="precio" class="block text-sm font-medium text-gray-700">Precio</label>
                                    <input type="text" name="precio" id="precio" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border">
                                </div>
                                <div>
                                    <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción</label>
                                    <textarea name="descripcion" id="descripcion" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border"></textarea>
                                </div>
                                <div>
                                    <label for="iconos" class="block text-sm font-medium text-gray-700">Iconos (separados por coma, ej: plane,hotel)</label>
                                    <input type="text" name="iconos" id="iconos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border">
                                </div>
                                <div>
                                    <label for="orden" class="block text-sm font-medium text-gray-700">Orden</label>
                                    <input type="number" name="orden" id="orden" value="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border">
                                </div>
                                <div>
                                    <label for="transporte" class="block text-sm font-medium text-gray-700">Tipo de Transporte</label>
                                    <select name="transporte" id="transporte" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border">
                                        <option value="">Seleccione</option>
                                        <option value="Aéreo">Aéreo</option>
                                        <option value="Terrestre">Terrestre</option>
                                        <option value="Marítimo">Marítimo</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="noches" class="block text-sm font-medium text-gray-700">Cantidad de Noches</label>
                                    <input type="text" name="noches" id="noches" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border" placeholder="Ej: 7 Noches">
                                </div>
                                <div>
                                    <label for="regimen" class="block text-sm font-medium text-gray-700">Régimen</label>
                                    <select name="regimen" id="regimen" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border">
                                        <option value="">Seleccione</option>
                                        <option value="Desayuno">Desayuno</option>
                                        <option value="Media Pensión">Media Pensión</option>
                                        <option value="Pensión Completa">Pensión Completa</option>
                                        <option value="All Inclusive">All Inclusive</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="servicios" class="block text-sm font-medium text-gray-700">Servicios Incluidos (separados por coma)</label>
                                    <textarea name="servicios" id="servicios" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border" placeholder="Ej: Alojamiento, Traslados, Excursiones"></textarea>
                                </div>
                                <div>
                                    <label for="pdf_url" class="block text-sm font-medium text-gray-700">URL del Itinerario PDF</label>
                                    <input type="url" name="pdf_url" id="pdf_url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border" placeholder="https://ejemplo.com/itinerario.pdf">
                                </div>
                                <div>
                                    <label for="fechas" class="block text-sm font-medium text-gray-700">Fecha de Inicio (o Fechas)</label>
                                    <input type="date" name="fechas" id="fechas" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border">
                                </div>
                                <div>
                                    <label for="region" class="block text-sm font-medium text-gray-700">Región</label>
                                    <input type="text" name="region" id="region" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border" placeholder="Ej: Sur Argentino, Caribe">
                                </div>

                                <div class="col-span-full border-t pt-6 mt-6">
                                    <h4 class="text-base font-semibold leading-6 text-gray-900 mb-4">Fechas y Tarifas</h4>
                                    <div id="tariffs-container">
                                        </div>
                                    <button type="button" id="add-tariff-button" class="mt-4 inline-flex items-center rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500">
                                        <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 2a.75.75 0 01.75.75v6.5a.75.75 0 01-1.5 0v-6.5A.75.75 0 0110 2zM5.25 10a.75.75 0 01.75-.75h8a.75.75 0 010 1.5h-8a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>
                                        Agregar Tarifa
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                            <button type="submit" class="inline-flex w-full justify-center rounded-md bg-[#033E4C] px-3 py-2 text-sm font-semibold text-white shadow-sm sm:ml-3 sm:w-auto">Guardar Paquete</button>
                            <button type="button" id="cancel-package-button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm sm:mt-0 sm:w-auto ring-1 ring-inset ring-gray-300">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Galería -->
    <div id="gallery-modal" class="relative z-20 hidden" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 modal-backdrop"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-3xl">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <h3 class="text-lg font-semibold leading-6 text-gray-900 mb-4">Seleccionar Imagen de Galería</h3>
                        <div id="gallery-image-list" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 max-h-96 overflow-y-auto p-2 border rounded-md">
                            </div>
                        <p id="gallery-loading-message" class="text-center text-gray-600 mt-4 hidden">Cargando imágenes...</p>
                        <p id="gallery-empty-message" class="text-center text-gray-600 mt-4 hidden">No hay imágenes en la galería.</p>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                        <button type="button" id="close-gallery-modal-btn" class="inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Reservas -->
    <div id="reserva-modal" class="relative z-10 hidden" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 modal-backdrop"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <form id="reserva-form">
                        <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                            <h3 class="text-lg font-semibold leading-6 text-gray-900" id="reserva-modal-title">Crear Reserva</h3>
                            <div class="mt-4 grid grid-cols-1 gap-y-4">
                                <input type="hidden" id="reserva-id" name="id">
                                <div>
                                    <label for="user_id" class="block text-sm font-medium text-gray-700">Cliente</label>
                                    <select id="user_id" name="user_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border"></select>
                                </div>
                                <div>
                                    <label for="paquete_nombre" class="block text-sm font-medium text-gray-700">Nombre del Paquete</label>
                                    <select id="paquete_nombre" name="paquete_nombre" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border"></select>
                                </div>
                                <div>
                                    <label for="fecha_reserva" class="block text-sm font-medium text-gray-700">Fecha de Reserva</label>
                                    <input type="date" name="fecha_reserva" id="fecha_reserva" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border">
                                </div>
                                <div>
                                    <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                                    <select id="estado" name="estado" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border">
                                        <option>Pendiente</option>
                                        <option>Confirmada</option>
                                        <option>Pagada</option>
                                        <option>Cancelada</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="notas" class="block text-sm font-medium text-gray-700">Notas</label>
                                    <textarea name="notas" id="notas" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                            <button type="submit" class="inline-flex w-full justify-center rounded-md bg-[#033E4C] px-3 py-2 text-sm font-semibold text-white sm:ml-3 sm:w-auto">Guardar Reserva</button>
                            <button type="button" id="cancel-reserva-button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm sm:mt-0 sm:w-auto ring-1 ring-inset ring-gray-300">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Banners -->
    <div id="banner-modal" class="relative z-10 hidden" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 modal-backdrop"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <form id="banner-form">
                        <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                            <h3 class="text-lg font-semibold leading-6 text-gray-900" id="banner-modal-title">Crear Banner</h3>
                            <div class="mt-4 grid grid-cols-1 gap-y-6">
                                <input type="hidden" id="banner-id" name="id">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Imagen</label>
                                    <div id="banner-drop-zone" class="mt-1 flex justify-center rounded-lg border-2 border-dashed border-gray-300 px-6 py-10 cursor-pointer hover:border-indigo-500">
                                        <div class="text-center">
                                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                            <p class="mt-1 text-sm text-gray-600">Arrastra y suelta o <span class="font-semibold text-indigo-600">haz clic</span></p>
                                            <input id="banner-file-input" type="file" class="sr-only" accept="image/*">
                                        </div>
                                    </div>
                                    <p id="banner-upload-status" class="mt-2 text-sm text-gray-500"></p>
                                    <img id="banner-image-preview" src="" class="mt-4 rounded-lg max-h-40 hidden">
                                    <button type="button" id="banner-select-from-gallery-btn" class="mt-2 block w-full rounded-md bg-gray-200 px-3 py-2 text-center text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-300">
                                        Seleccionar de la galería
                                    </button>
                                </div>
                                <div>
                                    <label for="banner_imagen_url" class="block text-sm font-medium text-gray-700">URL de la Imagen</label>
                                    <input type="url" name="imagen_url" id="banner_imagen_url" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border" placeholder="https://...">
                                </div>
                                <div>
                                    <label for="texto_overlay" class="block text-sm font-medium text-gray-700">Texto del Banner</label>
                                    <input type="text" name="texto_overlay" id="texto_overlay" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border" placeholder="Ej: JUNTOS POR EL MUNDO">
                                </div>
                                <div>
                                    <label for="banner_orden" class="block text-sm font-medium text-gray-700">Orden</label>
                                    <input type="number" name="orden" id="banner_orden" value="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 border">
                                </div>
                                <div class="flex items-center">
                                    <input id="activo" name="activo" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600">
                                    <label for="activo" class="ml-3 block text-sm font-medium leading-6 text-gray-900">Activo</label>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                            <button type="submit" class="inline-flex w-full justify-center rounded-md bg-[#033E4C] px-3 py-2 text-sm font-semibold text-white shadow-sm sm:ml-3 sm:w-auto">Guardar Banner</button>
                            <button type="button" id="cancel-banner-button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm sm:mt-0 sm:w-auto ring-1 ring-inset ring-gray-300">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- 1. CONFIGURACIÓN Y ELEMENTOS DEL DOM ---
        const SUPABASE_URL = 'https://rwndahfhxxasuwycfjug.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bmRhaGZoeHhhc3V3eWNmanVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMzA3MjUsImV4cCI6MjA2ODYwNjcyNX0.gZCP_LDl_WDqnhIIDHdqa-kWsDkYpxJ6RQxZcPtC0ZQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const logoutButton = document.getElementById('logout-button');
        // Package elements
        const packagesTableBody = document.getElementById('packages-table-body');
        const addPackageButton = document.getElementById('add-package-button');
        const packageModal = document.getElementById('package-modal');
        const packageForm = document.getElementById('package-form');
        const cancelPackageButton = document.getElementById('cancel-package-button');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const imageUrlInput = document.getElementById('imagen_url');
        const uploadStatus = document.getElementById('upload-status');
        const imagePreview = document.getElementById('image-preview');
        const selectFromGalleryBtn = document.getElementById('select-from-gallery-btn');
        const galleryModal = document.getElementById('gallery-modal');
        const galleryImageList = document.getElementById('gallery-image-list');
        const galleryLoadingMessage = document.getElementById('gallery-loading-message');
        const galleryEmptyMessage = document.getElementById('gallery-empty-message');
        const closeGalleryModalBtn = document.getElementById('close-gallery-modal-btn');
        const tariffsContainer = document.getElementById('tariffs-container');
        const addTariffButton = document.getElementById('add-tariff-button');
        // Reserva elements
        const reservasTableBody = document.getElementById('reservas-table-body');
        const addReservaButton = document.getElementById('add-reserva-button');
        const reservaModal = document.getElementById('reserva-modal');
        const reservaForm = document.getElementById('reserva-form');
        const cancelReservaButton = document.getElementById('cancel-reserva-button');
        const userSelectDropdown = document.getElementById('user_id');
        const paqueteSelectDropdown = document.getElementById('paquete_nombre');
        // Banner elements
        const bannersTableBody = document.getElementById('banners-table-body');
        const addBannerButton = document.getElementById('add-banner-button');
        const bannerModal = document.getElementById('banner-modal');
        const bannerForm = document.getElementById('banner-form');
        const cancelBannerButton = document.getElementById('cancel-banner-button');
        const bannerDropZone = document.getElementById('banner-drop-zone');
        const bannerFileInput = document.getElementById('banner-file-input');
        const bannerImageUrlInput = document.getElementById('banner_imagen_url');
        const bannerUploadStatus = document.getElementById('banner-upload-status');
        const bannerImagePreview = document.getElementById('banner-image-preview');
        const bannerSelectFromGalleryBtn = document.getElementById('banner-select-from-gallery-btn');


        let packagesData = [];
        let reservasData = [];
        let usersData = [];
        let bannersData = [];
        let currentModal = ''; // To track which modal is using the gallery

        // --- 3. FUNCIONES ---
        const togglePackageModal = () => packageModal.classList.toggle('hidden');
        const toggleReservaModal = () => reservaModal.classList.toggle('hidden');
        const toggleBannerModal = () => bannerModal.classList.toggle('hidden');
        const toggleGalleryModal = async (modalType) => {
            currentModal = modalType;
            galleryModal.classList.toggle('hidden');
            if (!galleryModal.classList.contains('hidden')) {
                await loadImagesIntoGallery();
            }
        };
        
        // --- LÓGICA DE PAQUETES ---
        const fetchPackages = async () => {
            const { data, error } = await supabase.from('destacados').select('*').order('orden', { ascending: true });
            
            if (error) {
                console.error("Error al cargar paquetes en el dashboard:", error);
                packagesTableBody.innerHTML = `<tr><td colspan="4" class="text-red-500 text-center py-4">Error al cargar paquetes.</td></tr>`;
                return;
            }
            packagesData = data;
            renderPackagesTable();
            populatePackagesDropdown();
        };

        const populatePackagesDropdown = () => {
            if (!paqueteSelectDropdown) return;
            paqueteSelectDropdown.innerHTML = `<option value="">Seleccionar un paquete...</option>`;
            packagesData.forEach(pkg => {
                const option = document.createElement('option');
                option.value = pkg.nombre;
                option.textContent = pkg.nombre;
                paqueteSelectDropdown.appendChild(option);
            });
        };

        const renderPackagesTable = () => {
            packagesTableBody.innerHTML = packagesData.map(pkg => `
                <tr>
                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-0">${pkg.orden}</td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${pkg.nombre}</td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${pkg.precio}</td>
                    <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                        <button data-id="${pkg.id}" class="text-indigo-600 hover:text-indigo-900 edit-package-btn">Editar</button>
                        <button onclick="deletePackage('${pkg.id}')" class="text-red-600 hover:text-red-900 ml-4">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        };

        const addTariffRow = (tariff = {}) => {
            const tariffId = tariff.id || `new-${Date.now()}`;
            const tariffDiv = document.createElement('div');
            tariffDiv.classList.add('tariff-item');
            tariffDiv.dataset.tariffId = tariffId;

            const formattedDate = tariff.fecha_salida ? new Date(tariff.fecha_salida).toISOString().split('T')[0] : '';

            tariffDiv.innerHTML = `
                <div>
                    <label class="block text-xs font-medium text-gray-700">Fecha Salida</label>
                    <input type="date" name="tariff-fecha_salida" value="${formattedDate}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-2 py-1 border text-sm">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Noches</label>
                    <input type="text" name="tariff-noches" value="${tariff.noches || ''}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-2 py-1 border text-sm">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Hotel Nombre</label>
                    <input type="text" name="tariff-hotel_nombre" value="${tariff.hotel_nombre || ''}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-2 py-1 border text-sm">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Hotel Link (opcional)</label>
                    <input type="url" name="tariff-hotel_url" value="${tariff.hotel_url || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-2 py-1 border text-sm" placeholder="https://">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Régimen</label>
                    <select name="tariff-regimen" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-2 py-1 border text-sm">
                        <option value="">Seleccione</option>
                        <option value="Desayuno" ${tariff.regimen === 'Desayuno' ? 'selected' : ''}>Desayuno</option>
                        <option value="Media Pensión" ${tariff.regimen === 'Media Pensión' ? 'selected' : ''}>Media Pensión</option>
                        <option value="Pensión Completa" ${tariff.regimen === 'Pensión Completa' ? 'selected' : ''}>Pensión Completa</option>
                        <option value="All Inclusive" ${tariff.regimen === 'All Inclusive' ? 'selected' : ''}>All Inclusive</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Tarifa</label>
                    <input type="text" name="tariff-tarifa" value="${tariff.tarifa || ''}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-2 py-1 border text-sm">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Moneda</label>
                    <input type="text" name="tariff-moneda" value="${tariff.moneda || 'USD'}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-2 py-1 border text-sm">
                </div>
                 <div>
                    <label class="block text-xs font-medium text-gray-700">Base</label>
                    <select name="tariff-base" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-2 py-1 border text-sm">
                        <option value="">Seleccione</option>
                        <option value="Single" ${tariff.base === 'Single' ? 'selected' : ''}>Single</option>
                        <option value="Doble" ${tariff.base === 'Doble' ? 'selected' : ''}>Doble</option>
                        <option value="Triple" ${tariff.base === 'Triple' ? 'selected' : ''}>Triple</option>
                    </select>
                </div>
                 <div class="col-span-full">
                    <label class="block text-xs font-medium text-gray-700">Notas Adicionales</label>
                    <textarea name="tariff-descripcion_adicional" rows="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-2 py-1 border text-sm">${tariff.descripcion_adicional || ''}</textarea>
                </div>
                <button type="button" class="delete-tariff-btn">Eliminar</button>
            `;
            tariffsContainer.appendChild(tariffDiv);

            tariffDiv.querySelector('.delete-tariff-btn').addEventListener('click', () => {
                tariffDiv.remove();
            });
        };

        const editPackage = async (pkg) => {
            packageForm.reset(); 
            clearUploadState('package');

            document.getElementById('package-modal-title').textContent = 'Editar Paquete';
            
            for (const key in pkg) {
                const element = packageForm.elements[key];
                if (element) {
                    if ((key === 'iconos' || key === 'servicios') && Array.isArray(pkg[key])) {
                        element.value = pkg[key].join(', ');
                    } else if (element.tagName === 'SELECT') {
                        element.value = pkg[key] || '';
                    } else if (element.type === 'date' && pkg[key]) {
                        element.value = pkg[key].split('T')[0];
                    }
                    else {
                        element.value = pkg[key];
                    }
                }
            }

            if (pkg.imagen_url) {
                imagePreview.src = pkg.imagen_url;
                imagePreview.classList.remove('hidden');
            } else {
                imagePreview.classList.add('hidden');
                imagePreview.src = '';
            }
            
            tariffsContainer.innerHTML = '';
            if (pkg.id) {
                const { data: tariffs, error } = await supabase
                    .from('paquete_tarifas')
                    .select('*')
                    .eq('paquete_id', pkg.id)
                    .order('fecha_salida', { ascending: true });

                if (error) {
                    console.error('Error al cargar tarifas del paquete:', error);
                    alert('Error al cargar tarifas del paquete.');
                } else {
                    if (tariffs.length === 0) {
                        addTariffRow();
                    } else {
                        tariffs.forEach(tariff => addTariffRow(tariff));
                    }
                }
            } else {
                addTariffRow();
            }

            togglePackageModal();
        };

        window.deletePackage = async (id) => {
            if (confirm('¿Estás seguro de que quieres eliminar este paquete y todas sus tarifas asociadas?')) {
                const { error: deleteTariffsError } = await supabase.from('paquete_tarifas').delete().eq('paquete_id', id);
                if (deleteTariffsError) {
                    alert('Error al eliminar las tarifas asociadas: ' + deleteTariffsError.message);
                    return;
                }

                const { error: deletePackageError } = await supabase.from('destacados').delete().eq('id', id);
                if (deletePackageError) {
                    alert('Error al eliminar el paquete: ' + deletePackageError.message);
                } else {
                    fetchPackages();
                }
            }
        };

        const uploadImage = async (file, type) => {
            if (!file) return;

            const statusEl = type === 'banner' ? bannerUploadStatus : uploadStatus;
            const previewEl = type === 'banner' ? bannerImagePreview : imagePreview;
            const urlInputEl = type === 'banner' ? bannerImageUrlInput : imageUrlInput;
            const bucketFolder = type === 'banner' ? 'grupales_banners' : 'destacados';

            statusEl.textContent = 'Subiendo imagen...';
            previewEl.classList.add('hidden');
            
            const filePath = `${bucketFolder}/${Date.now()}-${file.name}`;
            const { error: uploadError } = await supabase.storage.from('imagenes-web').upload(filePath, file);
            
            if (uploadError) {
                statusEl.textContent = 'Error al subir la imagen: ' + uploadError.message;
                return;
            }
            
            const { data } = supabase.storage.from('imagenes-web').getPublicUrl(filePath);
            statusEl.textContent = '¡Imagen subida con éxito!';
            urlInputEl.value = data.publicUrl;
            previewEl.src = data.publicUrl;
            previewEl.classList.remove('hidden');
        };

        const clearUploadState = (type) => {
             const statusEl = type === 'banner' ? bannerUploadStatus : uploadStatus;
             const previewEl = type === 'banner' ? bannerImagePreview : imagePreview;
             const fileInputEl = type === 'banner' ? bannerFileInput : fileInput;
             const urlInputEl = type === 'banner' ? bannerImageUrlInput : imageUrlInput;

             statusEl.textContent = '';
             previewEl.src = '';
             previewEl.classList.add('hidden');
             fileInputEl.value = '';
             urlInputEl.value = '';
        };

        const loadImagesIntoGallery = async () => {
            galleryImageList.innerHTML = '';
            galleryLoadingMessage.classList.remove('hidden');
            galleryEmptyMessage.classList.add('hidden');

            const { data, error } = await supabase.storage.from('imagenes-web').list('destinos', { 
                limit: 100, 
                offset: 0,
                sortBy: { column: 'created_at', order: 'desc' },
            });

            galleryLoadingMessage.classList.add('hidden');

            if (error) {
                console.error('Error al cargar imágenes de la galería:', error);
                galleryImageList.innerHTML = `<p class="text-red-500 col-span-full text-center">Error al cargar la galería.</p>`;
                return;
            }

            if (data.length === 0) {
                galleryEmptyMessage.classList.remove('hidden');
            } else {
                data.forEach(file => {
                    if (file.name !== '.emptyFolderPlaceholder') {
                        const publicUrl = supabase.storage.from('imagenes-web').getPublicUrl(`destinos/${file.name}`).data.publicUrl;
                        const imgDiv = document.createElement('div');
                        imgDiv.classList.add('gallery-image-item', 'relative', 'w-full', 'pt-[100%]');
                        imgDiv.innerHTML = `<img src="${publicUrl}" alt="${file.name}" class="absolute top-0 left-0 w-full h-full object-cover" data-url="${publicUrl}">`;
                        
                        imgDiv.querySelector('img').addEventListener('click', (e) => {
                            selectImageFromGallery(e.target.dataset.url);
                        });
                        galleryImageList.appendChild(imgDiv);
                    }
                });
            }
        };

        const selectImageFromGallery = (imageUrl) => {
            const urlInputEl = currentModal === 'banner' ? bannerImageUrlInput : imageUrlInput;
            const previewEl = currentModal === 'banner' ? bannerImagePreview : imagePreview;
            const statusEl = currentModal === 'banner' ? bannerUploadStatus : uploadStatus;

            urlInputEl.value = imageUrl;
            previewEl.src = imageUrl;
            previewEl.classList.remove('hidden');
            statusEl.textContent = 'URL seleccionada de la galería.';
            galleryModal.classList.add('hidden');
        };

        // --- LÓGICA DE BANNERS ---
        const fetchBanners = async () => {
            const { data, error } = await supabase.from('grupales_banners').select('*').order('orden', { ascending: true });
            if (error) {
                console.error("Error fetching banners:", error);
                bannersTableBody.innerHTML = `<tr><td colspan="5" class="text-red-500 text-center py-4">Error al cargar banners.</td></tr>`;
                return;
            }
            bannersData = data;
            renderBannersTable();
        };

        const renderBannersTable = () => {
            bannersTableBody.innerHTML = bannersData.map(banner => `
                <tr>
                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-0">
                        <img src="${banner.imagen_url}" alt="Banner" class="h-10 w-20 object-cover rounded">
                    </td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${banner.texto_overlay || ''}</td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${banner.orden}</td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                        <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ${banner.activo ? 'bg-green-50 text-green-700 ring-green-600/20' : 'bg-red-50 text-red-700 ring-red-600/20'} ring-1 ring-inset">
                            ${banner.activo ? 'Sí' : 'No'}
                        </span>
                    </td>
                    <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                        <button data-id="${banner.id}" class="text-indigo-600 hover:text-indigo-900 edit-banner-btn">Editar</button>
                        <button onclick="deleteBanner('${banner.id}')" class="text-red-600 hover:text-red-900 ml-4">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        };

        const editBanner = (banner) => {
            bannerForm.reset();
            clearUploadState('banner');
            document.getElementById('banner-modal-title').textContent = 'Editar Banner';
            bannerForm.id.value = banner.id;
            bannerForm.imagen_url.value = banner.imagen_url;
            bannerForm.texto_overlay.value = banner.texto_overlay || '';
            bannerForm.orden.value = banner.orden;
            bannerForm.activo.checked = banner.activo;
            if (banner.imagen_url) {
                bannerImagePreview.src = banner.imagen_url;
                bannerImagePreview.classList.remove('hidden');
            }
            toggleBannerModal();
        };

        window.deleteBanner = async (id) => {
            if (confirm('¿Estás seguro de que quieres eliminar este banner?')) {
                const { error } = await supabase.from('grupales_banners').delete().eq('id', id);
                if (error) {
                    alert('Error al eliminar el banner: ' + error.message);
                } else {
                    fetchBanners();
                }
            }
        };

        // --- LÓGICA DE RESERVAS ---
        const fetchUsers = async () => {
            const { data, error } = await supabase.rpc('get_all_users');
            if (error) { console.error('Error cargando usuarios:', error); return; }
            usersData = data;
            userSelectDropdown.innerHTML = `<option value="">Seleccionar cliente...</option>` + usersData.map(user => `<option value="${user.user_id}">${user.user_email}</option>`).join('');
        };

        const fetchReservas = async () => {
            const { data, error } = await supabase.rpc('get_all_reservas_with_emails');
            if (error) { console.error("Error al cargar reservas:", error); return; }
            reservasData = data;
            renderReservasTable();
        };

        const renderReservasTable = () => {
            reservasTableBody.innerHTML = reservasData.map(reserva => {
                const nombreCompleto = (reserva.user_nombre && reserva.user_apellido)
                    ? `${reserva.user_nombre} ${reserva.user_apellido}`
                    : reserva.user_email;
                
                return `
                    <tr>
                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-0">
                            <div>${nombreCompleto || 'Usuario no encontrado'}</div>
                            <div class="text-xs text-gray-500">${reserva.user_email}</div>
                        </td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${reserva.user_telefono || ''}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${reserva.paquete_nombre}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${reserva.fecha_reserva || ''}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${reserva.estado}</td>
                        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                            <button data-id="${reserva.id}" class="text-indigo-600 hover:text-indigo-900 edit-reserva-btn">Editar</button>
                            <button onclick="deleteReserva('${reserva.id}')" class="text-red-600 hover:text-red-900 ml-4">Eliminar</button>
                        </td>
                    </tr>
            `}).join('');
        };

        const editReserva = (reserva) => {
            reservaForm.reset();
            document.getElementById('reserva-modal-title').textContent = 'Editar Reserva';
            reservaForm.id.value = reserva.id;
            reservaForm.user_id.value = reserva.user_id;
            reservaForm.paquete_nombre.value = reserva.paquete_nombre;
            reservaForm.fecha_reserva.value = reserva.fecha_reserva;
            reservaForm.estado.value = reserva.estado;
            reservaForm.notas.value = reserva.notas || '';
            toggleReservaModal();
        };
        
        window.deleteReserva = async (id) => {
            if (confirm('¿Estás seguro de que quieres eliminar esta reserva?')) {
                const { error } = await supabase.from('reservas').delete().eq('id', id);
                if (error) { alert('Error al eliminar la reserva.'); }
                else { fetchReservas(); }
            }
        };

        // --- 4. EVENT LISTENERS ---
        logoutButton.addEventListener('click', async () => { await supabase.auth.signOut(); window.location.href = './index.html'; });
        
        addPackageButton.addEventListener('click', () => { 
            packageForm.reset(); 
            clearUploadState('package'); 
            document.getElementById('package-modal-title').textContent = 'Crear Paquete'; 
            tariffsContainer.innerHTML = '';
            addTariffRow();
            togglePackageModal(); 
        });
        
        cancelPackageButton.addEventListener('click', togglePackageModal);
        
        packagesTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-package-btn')) {
                const packageId = e.target.dataset.id;
                const packageToEdit = packagesData.find(p => p.id == packageId);
                if (packageToEdit) editPackage(packageToEdit);
            }
        });

        addTariffButton.addEventListener('click', () => addTariffRow());
        selectFromGalleryBtn.addEventListener('click', () => toggleGalleryModal('package'));
        closeGalleryModalBtn.addEventListener('click', () => galleryModal.classList.add('hidden'));
        galleryModal.addEventListener('click', (event) => {
            if (event.target === galleryModal) {
                galleryModal.classList.add('hidden');
            }
        });


        packageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(packageForm);
            
            const packageData = {};
            const mainPackageFields = [
                'id', 'nombre', 'imagen_url', 'precio', 'descripcion', 'iconos', 
                'orden', 'transporte', 'noches', 'regimen', 'servicios', 
                'pdf_url', 'fechas', 'region'
            ];

            for (const field of mainPackageFields) {
                if (formData.has(field)) {
                    packageData[field] = formData.get(field);
                }
            }
            
            packageData.iconos = packageData.iconos.split(',').map(item => item.trim()).filter(Boolean);
            packageData.servicios = packageData.servicios.split(',').map(item => item.trim()).filter(Boolean);

            const packageId = packageData.id;
            delete packageData.id;

            const tariffRows = tariffsContainer.querySelectorAll('.tariff-item');
            const tariffsToSave = [];
            let isValidTariffs = true;

            tariffRows.forEach(row => {
                const tariff = {};
                row.querySelectorAll('input, select, textarea').forEach(input => {
                    const fieldName = input.name.replace('tariff-', '');
                    tariff[fieldName] = input.value;
                });
                if (!tariff.fecha_salida || !tariff.noches || !tariff.hotel_nombre || !tariff.regimen || !tariff.tarifa || !tariff.base) {
                    isValidTariffs = false;
                    alert('Por favor, complete todos los campos requeridos para cada tarifa (incluida la Base).');
                    return;
                }
                tariffsToSave.push(tariff);
            });

            if (!isValidTariffs) {
                return;
            }
            
            let error;
            let currentPackageId = packageId;

            if (packageId) { 
                const { error: updateError } = await supabase.from('destacados').update(packageData).eq('id', packageId); 
                error = updateError; 
            } else { 
                const { data: newPackage, error: insertError } = await supabase.from('destacados').insert([packageData]).select().single();
                error = insertError;
                if (newPackage) {
                    currentPackageId = newPackage.id;
                }
            }
            
            if (error) { 
                alert('Error al guardar el paquete principal: ' + error.message); 
            } else {
                const { error: deleteOldTariffsError } = await supabase.from('paquete_tarifas').delete().eq('paquete_id', currentPackageId);
                if (deleteOldTariffsError) {
                    alert('Error al limpiar tarifas antiguas: ' + deleteOldTariffsError.message);
                }

                if (tariffsToSave.length > 0) {
                    const tariffsWithPackageId = tariffsToSave.map(tariff => ({
                        ...tariff,
                        paquete_id: currentPackageId
                    }));
                    const { error: insertTariffsError } = await supabase.from('paquete_tarifas').insert(tariffsWithPackageId);
                    if (insertTariffsError) {
                        alert('Error al guardar las nuevas tarifas: ' + insertTariffsError.message);
                    }
                }
                alert('Paquete y tarifas guardados con éxito.');
                togglePackageModal(); 
                await fetchPackages();
            }
        });
        
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => { 
            e.preventDefault(); 
            dropZone.classList.remove('drag-over'); 
            const file = e.dataTransfer.files[0]; 
            if (file) { 
                const dataTransfer = new DataTransfer(); 
                dataTransfer.items.add(file); 
                fileInput.files = dataTransfer.files; 
                uploadImage(file, 'package'); 
            }
        });
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });
        fileInput.addEventListener('change', () => { const file = fileInput.files[0]; uploadImage(file, 'package'); });

        // --- Banner Event Listeners ---
        addBannerButton.addEventListener('click', () => {
            bannerForm.reset();
            clearUploadState('banner');
            document.getElementById('banner-modal-title').textContent = 'Crear Banner';
            bannerForm.activo.checked = true; // Default to active
            toggleBannerModal();
        });

        cancelBannerButton.addEventListener('click', toggleBannerModal);

        bannersTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-banner-btn')) {
                const bannerId = e.target.dataset.id;
                const bannerToEdit = bannersData.find(b => b.id == bannerId);
                if (bannerToEdit) editBanner(bannerToEdit);
            }
        });

        bannerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(bannerForm);
            const bannerData = {
                imagen_url: formData.get('imagen_url'),
                texto_overlay: formData.get('texto_overlay'),
                orden: formData.get('orden'),
                activo: formData.get('activo') === 'on', // Convert checkbox value to boolean
            };
            const bannerId = formData.get('id');
            
            let error;
            if (bannerId) {
                const { error: updateError } = await supabase.from('grupales_banners').update(bannerData).eq('id', bannerId);
                error = updateError;
            } else {
                const { error: insertError } = await supabase.from('grupales_banners').insert([bannerData]);
                error = insertError;
            }

            if (error) {
                alert('Error al guardar el banner: ' + error.message);
                console.error(error);
            } else {
                toggleBannerModal();
                fetchBanners();
            }
        });
        
        bannerDropZone.addEventListener('dragover', (e) => { e.preventDefault(); bannerDropZone.classList.add('drag-over'); });
        bannerDropZone.addEventListener('dragleave', () => bannerDropZone.classList.remove('drag-over'));
        bannerDropZone.addEventListener('drop', (e) => { 
            e.preventDefault(); 
            bannerDropZone.classList.remove('drag-over'); 
            const file = e.dataTransfer.files[0]; 
            if (file) { 
                const dataTransfer = new DataTransfer(); 
                dataTransfer.items.add(file); 
                bannerFileInput.files = dataTransfer.files; 
                uploadImage(file, 'banner'); 
            }
        });
        bannerDropZone.addEventListener('click', () => {
            bannerFileInput.click();
        });
        bannerFileInput.addEventListener('change', () => { const file = bannerFileInput.files[0]; uploadImage(file, 'banner'); });
        bannerSelectFromGalleryBtn.addEventListener('click', () => toggleGalleryModal('banner'));


        // --- Reserva Event Listeners ---
        addReservaButton.addEventListener('click', () => { reservaForm.reset(); document.getElementById('reserva-modal-title').textContent = 'Crear Reserva'; toggleReservaModal(); });
        cancelReservaButton.addEventListener('click', toggleReservaModal);
        reservasTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-reserva-btn')) {
                const reservaId = e.target.dataset.id;
                const reservaToEdit = reservasData.find(r => r.id == reservaId);
                if (reservaToEdit) editReserva(reservaToEdit);
            }
        });
        reservaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(reservaForm);
            const reservaData = Object.fromEntries(formData.entries());
            const reservaId = reservaData.id;
            delete reservaData.id;
            let error;
            if (reservaId) { const { error: updateError } = await supabase.from('reservas').update(reservaData).eq('id', reservaId); error = updateError; }
            else { const { error: insertError } = await supabase.from('reservas').insert([reservaData]); error = insertError; }
            if (error) { alert('Error al guardar la reserva.'); console.error(error); }
            else { toggleReservaModal(); fetchReservas(); }
        });

        // --- 5. INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { 
                window.location.href = './index.html'; 
                return; 
            }
            
            const { data: profile, error } = await supabase.from('profiles').select('role').eq('id', session.user.id).single();
            if (error || profile?.role !== 'admin') {
                alert("Acceso denegado. Esta área es solo para administradores.");
                await supabase.auth.signOut();
                window.location.href = './index.html'; // Redirigir a la página principal si no es admin
                return;
            }
            
            await fetchUsers();
            await fetchPackages();
            await fetchReservas();
            await fetchBanners(); // Cargar los banners al iniciar
        });
    </script>
</body>
</html>
